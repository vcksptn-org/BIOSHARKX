<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VCKSPTN — Cloud Terminal</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    background:black;
    color:#00ff6b;
    font-family: "Courier New", monospace;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
  }

  .container{
    width:100%;
    max-width:980px;
    display:flex;
    gap:24px;
    align-items:flex-start;
  }

  /* small left matrix preview */
  .left {
    flex:1;
    min-width:260px;
  }
  .matrix-mini {
    width:100%;
    height:420px;
    border-radius:8px;
    background:linear-gradient(180deg, #001100, #000000);
    box-shadow:0 0 20px rgba(0,255,107,0.05);
    position:relative;
    overflow:hidden;
  }

  .terminal {
    flex:1.15;
    min-width:320px;
    background:rgba(0,0,0,0.6);
    border:2px solid rgba(0,255,107,0.18);
    padding:16px;
    border-radius:8px;
    box-shadow:0 0 30px rgba(0,255,107,0.03);
  }

  .term-inner {
    background:linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.2));
    padding:14px;
    border-radius:6px;
    min-height:220px;
    color:#bfffdc;
    font-size:13px;
    line-height:1.3;
    position:relative;
  }

  .led {
    position:absolute;
    right:12px;
    top:12px;
    width:22px;height:22px;border-radius:50%;
    background:#333;
    box-shadow:0 0 12px rgba(0,0,0,0.2);
  }
  .led.on {
    background:#00ff6b;
    box-shadow:0 0 18px rgba(0,255,107,0.9);
    animation:blink 1.2s infinite;
  }
  @keyframes blink {
    0%{opacity:1}50%{opacity:.25}100%{opacity:1}
  }

  .term-lines{ white-space:pre-line; font-family:monospace; font-size:13px }

  .controls{
    margin-top:12px;
    display:flex;
    gap:10px;
    align-items:center;
  }

  input[type="file"]{
    color:#00ff6b;
    background:#07110a;
    border:1px solid rgba(0,255,107,0.08);
    padding:8px 10px;
    border-radius:6px;
  }

  button {
    background:#00ff6b;
    color:#001b0c;
    border:none;
    padding:8px 12px;
    border-radius:6px;
    cursor:pointer;
    font-weight:700;
  }

  .list {
    margin-top:14px;
    max-height:220px;
    overflow:auto;
    border-top:1px dashed rgba(0,255,107,0.06);
    padding-top:10px;
  }

  .file-item{
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:space-between;
    padding:8px 6px;
    border-radius:6px;
  }
  .file-item a{ color:#9ef0c3; text-decoration:none; font-size:13px }
  .url { font-size:12px; color:#7af0bd; word-break:break-all; max-width:420px }

  .small { font-size:12px; color:rgba(0,255,107,0.55) }

  .progress {
    height:8px;
    width:100%;
    background:#05230f;
    border-radius:6px;
    margin-top:8px;
    overflow:hidden;
  }
  .progress > i{ display:block; height:8px; background:linear-gradient(90deg,#00ff6b,#00d487); width:0%; transition:width .2s linear }

  .note { margin-top:8px; font-size:12px; color:rgba(0,255,107,0.45) }
</style>
</head>
<body>

<div class="container">
  <div class="left">
    <div class="matrix-mini" id="mini">
      <!-- visual placeholder -->
    </div>
    <div style="margin-top:10px;color:#9df7c9;font-size:13px">Terminal Access</div>
    <div class="small">Klik kotak terminal di kanan untuk mulai koneksi manual.</div>
  </div>

  <div class="terminal">
    <div class="term-inner" id="terminalBox" role="button" tabindex="0">
      <div class="led" id="led"></div>
      <div class="term-lines" id="termText">
> Terminal offline. Press the terminal to connect...
      </div>
    </div>

    <div class="controls" id="controls" style="display:none">
      <input type="file" id="fileInput" accept="image/*,audio/*,video/*"/>
      <button id="uploadBtn">Upload</button>
      <button id="refreshBtn">Refresh List</button>
    </div>

    <div class="progress" id="progress" style="display:none"><i id="bar"></i></div>
    <div class="note" id="note"></div>

    <div class="list" id="fileList"></div>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

  // ---------- CONFIG (ganti sesuai project mu kalo perlu) ----------
  const SUPABASE_URL = 'https://dfsjotpribiupxmsmdce.supabase.co'
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmc2pvdHByaWJpdXB4bXNtZGNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNjg3MjEsImV4cCI6MjA3NjY0NDcyMX0.FQ4NvDvVa8sWjbsJ6Ft-__8l-2q7qP95QW1uW8GF2Yo'
  const PUBLIC_BUCKET = 'Public'   // bucket public untuk upload & share
  // ------------------------------------------------------------------

  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

  // UI refs
  const terminalBox = document.getElementById('terminalBox')
  const termText = document.getElementById('termText')
  const led = document.getElementById('led')
  const controls = document.getElementById('controls')
  const fileInput = document.getElementById('fileInput')
  const uploadBtn = document.getElementById('uploadBtn')
  const refreshBtn = document.getElementById('refreshBtn')
  const fileList = document.getElementById('fileList')
  const progress = document.getElementById('progress')
  const bar = document.getElementById('bar')
  const note = document.getElementById('note')

  let connected = false

  // Manual connect handler (user clicks terminal to connect)
  terminalBox.addEventListener('click', async () => {
    if (connected) return
    await startManualConnect()
  })

  async function startManualConnect(){
    // animate text
    termText.textContent = '> Initializing access...\n> System status: OK\n> Loading user environment...'
    await sleep(800)
    termText.textContent += '\n> Access granted.'
    led.classList.add('on')
    await sleep(600)
    termText.textContent += '\n> Hello, Operator. Welcome back.'
    connected = true

    // show controls
    controls.style.display = 'flex'
    note.textContent = 'Connected to Supabase (manual). Using PUBLIC bucket for uploads.'
    // initial file fetch
    await fetchFileList()
  }

  uploadBtn.addEventListener('click', async () => {
    const file = fileInput.files[0]
    if (!file) { alert('Pilih file dulu bro'); return }
    await uploadFile(file)
  })

  refreshBtn.addEventListener('click', fetchFileList)

  async function uploadFile(file){
    try {
      progress.style.display = 'block'
      bar.style.width = '6%'
      // create unique filename to reduce collisions
      const fname = `${Date.now()}_${sanitizeFilename(file.name)}`
      const path = `uploads/${fname}`

      // supabase storage upload
      const { data, error } = await supabase.storage
        .from(PUBLIC_BUCKET)
        .upload(path, file, { cacheControl: '3600', upsert: false })

      if (error){
        note.textContent = 'Upload error: ' + error.message
        progress.style.display = 'none'
        return
      }

      // done
      bar.style.width = '100%'
      note.textContent = 'Upload successful!'
      // get public url
      const { data: publicData } = supabase.storage.from(PUBLIC_BUCKET).getPublicUrl(path)
      const fileUrl = publicData.publicUrl
      // show result and refresh list
      await fetchFileList()
      // scroll to uploaded item
      setTimeout(()=> {
        const a = document.querySelector(`[data-path="${path}"]`)
        if (a) a.scrollIntoView({behavior:'smooth', block:'center'})
      },350)
    } catch (err) {
      note.textContent = 'Upload failed: ' + (err.message || err)
    } finally {
      setTimeout(()=>{ progress.style.display='none'; bar.style.width='0%' }, 700)
    }
  }

  async function fetchFileList(){
    fileList.innerHTML = ''
    note.textContent = 'Loading file list...'
    // list objects in bucket
    const { data, error } = await supabase.storage.from(PUBLIC_BUCKET).list('uploads', { limit:100, offset:0, sortBy:{ column: 'name', order: 'desc' } })
    if (error){
      note.textContent = 'List error: ' + error.message
      return
    }
    if (!data || data.length===0){
      fileList.innerHTML = '<div class="small">Folder kosong.</div>'
      note.textContent = 'No files found.'
      return
    }

    note.textContent = `Found ${data.length} file(s).`
    data.forEach(item => {
      const path = `uploads/${item.name}`
      const { data: pub } = supabase.storage.from(PUBLIC_BUCKET).getPublicUrl(path)
      const url = pub.publicUrl
      const el = document.createElement('div')
      el.className = 'file-item'
      el.innerHTML = `
        <div>
          <div style="font-weight:700">${item.name}</div>
          <div class="small">${new Date(item.last_modified).toLocaleString()}</div>
        </div>
        <div style="text-align:right;max-width:460px">
          <div class="url"><a href="${url}" target="_blank">${shorten(url,52)}</a></div>
          <div style="margin-top:6px">
            <button onclick="copyUrl('${url.replace(/'/g,"\\'")}')">Copy URL</button>
          </div>
        </div>
      `
      el.setAttribute('data-path', path)
      fileList.appendChild(el)
    })
  }

  window.copyUrl = (u) => {
    navigator.clipboard.writeText(u).then(()=> note.textContent='URL copied to clipboard')
  }

  // helpers
  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)) }
  function sanitizeFilename(name){
    return name.replace(/[^a-zA-Z0-9\-_\.]/g, '_')
  }
  function shorten(s, n){
    if (!s) return ''
    if (s.length<=n) return s
    return s.slice(0, Math.floor(n/2)) + '…' + s.slice(-Math.floor(n/2))
  }

  // initial mini matrix canvas
  const mini = document.getElementById('mini')
  const c = document.createElement('canvas'); mini.appendChild(c)
  c.width = mini.clientWidth; c.height = mini.clientHeight
  const g = c.getContext('2d')
  const cols = Math.floor(c.width/12)
  const ypos = Array(cols).fill(0)
  function miniLoop(){
    g.fillStyle = 'rgba(0,0,0,0.06)'; g.fillRect(0,0,c.width,c.height)
    g.fillStyle = '#00ff6b'; g.font='12px monospace'
    for (let i=0;i<ypos.length;i++){
      const ch = String.fromCharCode(0x30A0 + Math.random()*96)
      g.fillText(ch, i*12, ypos[i]*12)
      if (ypos[i]*12 > c.height && Math.random()>0.98) ypos[i]=0
      ypos[i]++
    }
    requestAnimationFrame(miniLoop)
  }
  miniLoop()
</script>
</body>
</html>
